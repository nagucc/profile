{"version":3,"file":"index.es6.js","sources":["../src/Profile-mongo.js","../src/mongo-express-middlewares.js"],"sourcesContent":["/*\n根据微信企业号的userid记录用户的相关信息\n字段包括：_id, userid, roles, name, isMale, phone\n */\n\nimport { useCollection } from 'mongo-use-collection';\n\n\nexport default class Profle {\n  constructor(url, collection = 'profles') {\n    this.useProfiles = cb => useCollection(url, collection, cb);\n  }\n\n  /*\n  添加profile\n   */\n  add(profile = {}) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const result = await col.insertOne(profile);\n          resolve(result);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  getByUserId(userid) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne({ userid });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  get(_id) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne({ _id });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  findOne(query) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne(query);\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  update(_id, profile = {}) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const oldDoc = await this.get(_id);\n          const doc = {\n            ...oldDoc,\n            ...profile,\n          };\n          await col.updateOne({ _id }, { $set: doc });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  remove(_id) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const result = await col.remove({ _id });\n          resolve(result);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n }\n\n// const PROFILE_COLLECTION = 'profiles';\n\n// const dao = new WxeProfle(mongoUrl, PROFILE_COLLECTION);\n// export default dao;\n","/*\neslint-disable no-param-reassign, no-underscore-dangle\n */\nimport { SERVER_FAILED,\n  OBJECT_IS_UNDEFINED_OR_NULL, OBJECT_IS_NOT_FOUND, REQUIRED } from 'nagu-validates';\n\nimport { Profile } from './index';\n\nexport default class MongoProfileMiddlewares {\n  constructor(mongoUrl, collection = 'profiles', getId) {\n    this.mongoUrl = mongoUrl;\n    this.collection = collection;\n    this.getId = getId;\n    this.dao = new Profile(this.mongoUrl, this.collection);\n  }\n  /*\n  添加Profile\n   */\n  add(\n    // 定义获取profile数据的方法，默认取req.body的全部数据\n    composeProfile = req => req.body,\n    // 定义操作成功之后的动作，默认继续指向下一个中间件。\n    success = (profile, req, res, next) => next(),\n    // 定义操作失败之后的动作，默认为输出\n    fail = (err, req, res) => res.send(err),\n  ) {\n    return async (req, res, next) => {\n      try {\n        const profile = composeProfile(req, res);\n        if (!profile.name) {\n          fail({\n            ret: OBJECT_IS_UNDEFINED_OR_NULL,\n            msg: '姓名不能为空',\n          }, req, res, next);\n          return;\n        }\n        const result = await this.dao.add(profile);\n        success({ _id: result.insertedId, ...profile }, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n  // 根据Id获取profile\n  get(\n    // 定义获取Id的方法，默认取url中的id参数\n    getId = req => req.params.id,\n    // 定义操作成功之后的动作，默认继续指向下一个中间件。\n    success = (doc, req, res, next) => next(),\n    // 定义操作失败之后的动作，默认为输出\n    fail = (result, req, res) => res.send(result),\n  ) {\n    return async (req, res, next) => {\n      try {\n        const _id = getId(req, res);\n        if (!_id) {\n          fail({ ret: OBJECT_IS_UNDEFINED_OR_NULL, msg: '必须指定id' }, req, res, next);\n          return;\n        }\n        const doc = await this.dao.get(_id);\n        success(doc, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n\n  findOne(getQuery, success = (doc, req, res, next) => {\n    res.profile = doc;\n    next();\n  }, fail = (result, req, res) => {\n    res.send(result);\n  }) {\n    return async (req, res, next) => {\n      try {\n        const query = getQuery(req, res);\n        const doc = await this.dao.findOne(query);\n        success(doc, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n  update(getId, composeProfile) {\n    return async (req, res, next) => {\n      const _id = getId(req, res);\n      const profile = composeProfile(req, res);\n      try {\n        await this.dao.update(_id, profile);\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n  remove(getId) {\n    return async (req, res, next) => {\n      const _id = getId(req, res);\n      try {\n        await this.dao.remove(_id);\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n\n// 判断当前用户是否是指定profile的所有者\n  isOwner(\n    getId = () => null,\n    getCurrentUserId = () => null,\n    success = (result, req, res, next) => next(),\n    fail = (err, req, res) => res.send(err),\n  ) {\n    return async (req, res, next) => {\n      try {\n        const id = getId(req, res);\n        // 确保profile.id不为空\n        if (!id) {\n          fail({ ret: OBJECT_IS_UNDEFINED_OR_NULL, msg: 'profile的Id不能为空' }, req, res, next);\n          return;\n        }\n        const data = await this.dao.get(id);\n        // 确保id正确，能取到数据\n        if (!data) {\n          fail({ ret: OBJECT_IS_NOT_FOUND, msg: '对象不存在' }, req, res, next);\n          return;\n        }\n        const userid = getCurrentUserId(req, res, next);\n        success(userid === data.userid, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n\n  isManager(\n    getCurrentUserId = () => null,\n    managerGroupId,\n    success = (result, req, res, next) => next(),\n    fail = (err, req, res) => res.send(err),\n  ) {\n    return async (req, res, next) => {\n      if (!managerGroupId) {\n        fail({ ret: REQUIRED, msg: '必须提供正确的MangerGroupId' }, req, res, next);\n        return;\n      }\n      const userid = getCurrentUserId(req, res);\n      const profile = await this.dao.getByUserId(userid);\n      let result = false;\n      if (profile.roles && profile.roles.length) {\n        result = profile.roles.some(role => role === managerGroupId);\n      }\n      success(result, req, res, next);\n    };\n  }\n\n  isSupervisor(\n    getCurrentUserId = () => null,\n    supervisorGroupId,\n    success = (result, req, res, next) => next(),\n    fail = (err, req, res) => res.send(err),\n  ) {\n    return async (req, res, next) => {\n      if (!supervisorGroupId) {\n        fail({ ret: REQUIRED, msg: '必须提供正确的SupervisorGroupId' }, req, res, next);\n        return;\n      }\n      const userid = getCurrentUserId(req, res);\n      const profile = await this.dao.getByUserId(userid);\n      let result = false;\n      if (profile.roles && profile.roles.length) {\n        result = profile.roles.some(role => role === supervisorGroupId);\n      }\n      success(result, req, res, next);\n    };\n  }\n}\n"],"names":["Profile"],"mappings":"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"}