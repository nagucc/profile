{"version":3,"file":"index.js","sources":["../src/Profile-mongo.js","../src/mongo-express-middlewares.js"],"sourcesContent":["/*\n根据微信企业号的userid记录用户的相关信息\n字段包括：_id, userid, roles, name, isMale, phone\n */\n\nimport { useCollection } from 'mongo-use-collection';\n\n\nexport default class Profle {\n  constructor(url, collection = 'profles') {\n    this.useProfiles = cb => useCollection(url, collection, cb);\n  }\n\n  /*\n  添加profile\n   */\n  add(profile = {}) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const result = await col.insertOne(profile);\n          resolve(result);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  getByUserId(userid) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne({ userid });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  get(_id) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne({ _id });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  findOne(query) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne(query);\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  update(_id, profile = {}) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const oldDoc = await this.get(_id);\n          const doc = {\n            ...oldDoc,\n            ...profile,\n          };\n          await col.updateOne({ _id }, { $set: doc });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  remove(_id) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const result = await col.remove({ _id });\n          resolve(result);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n }\n\n// const PROFILE_COLLECTION = 'profiles';\n\n// const dao = new WxeProfle(mongoUrl, PROFILE_COLLECTION);\n// export default dao;\n","/*\neslint-disable no-param-reassign, no-underscore-dangle\n */\nimport { SERVER_FAILED,\n  OBJECT_IS_UNDEFINED_OR_NULL } from 'nagu-validates';\n\nimport { Profile } from './index';\n\nexport default class MongoProfileMiddlewares {\n  constructor(mongoUrl, collection = 'profiles', getId) {\n    this.mongoUrl = mongoUrl;\n    this.collection = collection;\n    this.getId = getId;\n    this.dao = new Profile(this.mongoUrl, this.collection);\n  }\n  /*\n  添加Profile\n   */\n  add(composeProfile) {\n    return async (req, res, next) => {\n      try {\n        const profile = composeProfile(req, res);\n        if (!profile.name) {\n          res.send({\n            ret: OBJECT_IS_UNDEFINED_OR_NULL,\n            msg: '姓名不能为空',\n          });\n          return;\n        }\n        const result = await this.dao.add(profile);\n        req.body._id = result.insertedId;\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n  get(getId,\n    success = (doc, req, res, next) => {\n      res.profile = doc;\n      next();\n    },\n    fail = (result, req, res) => {\n      res.send(result);\n    }) {\n    return async (req, res, next) => {\n      try {\n        const _id = getId(req, res);\n        const doc = await this.dao.get(_id);\n        success(doc, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n\n  findOne(getQuery, success = (doc, req, res, next) => {\n    res.profile = doc;\n    next();\n  }, fail = (result, req, res) => {\n    res.send(result);\n  }) {\n    return async (req, res, next) => {\n      try {\n        const query = getQuery(req, res);\n        const doc = await this.dao.findOne(query);\n        success(doc, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n  update(getId, composeProfile) {\n    return async (req, res, next) => {\n      const _id = getId(req, res);\n      const profile = composeProfile(req, res);\n      try {\n        await this.dao.update(_id, profile);\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n  remove(getId) {\n    return async (req, res, next) => {\n      const _id = getId(req, res);\n      try {\n        await this.dao.remove(_id);\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n}\n"],"names":["useCollection","Profile","OBJECT_IS_UNDEFINED_OR_NULL","SERVER_FAILED"],"mappings":"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"}