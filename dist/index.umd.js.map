{"version":3,"file":"index.umd.js","sources":["../src/Profile-mongo.js","../src/mongo-express-middlewares.js"],"sourcesContent":["/*\n根据微信企业号的userid记录用户的相关信息\n字段包括：_id, userid, roles, name, isMale, phone\n */\n\nimport { useCollection } from 'mongo-use-collection';\n\n\nexport default class Profle {\n  constructor(url, collection = 'profles') {\n    this.useProfiles = cb => useCollection(url, collection, cb);\n  }\n\n  /*\n  添加profile\n   */\n  add(profile = {}) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const result = await col.insertOne(profile);\n          resolve(result);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  getByUserId(userid) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne({ userid });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  get(_id) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne({ _id });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  findOne(query) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const doc = await col.findOne(query);\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  update(_id, profile = {}) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const oldDoc = await this.get(_id);\n          const doc = {\n            ...oldDoc,\n            ...profile,\n          };\n          await col.updateOne({ _id }, { $set: doc });\n          resolve(doc);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n  remove(_id) {\n    return new Promise((resolve, reject) =>\n      this.useProfiles(async col => {\n        try {\n          const result = await col.remove({ _id });\n          resolve(result);\n        } catch (e) {\n          reject(e);\n        }\n      }));\n  }\n }\n\n// const PROFILE_COLLECTION = 'profiles';\n\n// const dao = new WxeProfle(mongoUrl, PROFILE_COLLECTION);\n// export default dao;\n","/*\neslint-disable no-param-reassign, no-underscore-dangle\n */\nimport { SERVER_FAILED,\n  OBJECT_IS_UNDEFINED_OR_NULL } from 'nagu-validates';\n\nimport { Profile } from './index';\n\nexport default class MongoProfileMiddlewares {\n  constructor(mongoUrl, collection = 'profiles', getId) {\n    this.mongoUrl = mongoUrl;\n    this.collection = collection;\n    this.getId = getId;\n    this.dao = new Profile(this.mongoUrl, this.collection);\n  }\n  /*\n  添加Profile\n   */\n  add(composeProfile) {\n    return async (req, res, next) => {\n      try {\n        const profile = composeProfile(req, res);\n        if (!profile.name) {\n          res.send({\n            ret: OBJECT_IS_UNDEFINED_OR_NULL,\n            msg: '姓名不能为空',\n          });\n          return;\n        }\n        const result = await this.dao.add(profile);\n        req.body._id = result.insertedId;\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n  get(getId,\n    success = (doc, req, res, next) => {\n      res.profile = doc;\n      next();\n    },\n    fail = (result, req, res) => {\n      res.send(result);\n    }) {\n    return async (req, res, next) => {\n      try {\n        const _id = getId(req, res);\n        const doc = await this.dao.get(_id);\n        success(doc, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n\n  findOne(getQuery, success = (doc, req, res, next) => {\n    res.profile = doc;\n    next();\n  }, fail = (result, req, res) => {\n    res.send(result);\n  }) {\n    return async (req, res, next) => {\n      try {\n        const query = getQuery(req, res);\n        const doc = await this.dao.findOne(query);\n        success(doc, req, res, next);\n      } catch (e) {\n        fail({\n          ret: SERVER_FAILED,\n          msg: e,\n        }, req, res, next);\n      }\n    };\n  }\n  update(getId, composeProfile) {\n    return async (req, res, next) => {\n      const _id = getId(req, res);\n      const profile = composeProfile(req, res);\n      try {\n        await this.dao.update(_id, profile);\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n  remove(getId) {\n    return async (req, res, next) => {\n      const _id = getId(req, res);\n      try {\n        await this.dao.remove(_id);\n        next();\n      } catch (e) {\n        res.send({\n          ret: SERVER_FAILED,\n          msg: e,\n        });\n      }\n    };\n  }\n}\n"],"names":["useCollection","Profile","OBJECT_IS_UNDEFINED_OR_NULL","SERVER_FAILED"],"mappings":"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"}